<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compliance Roadmap</title>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;background:#F5F5F5}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .header{background:#007e83;color:#fff;padding:10px;border-radius:8px 8px 0 0;text-align:center}
    .section{padding:20px;border-bottom:1px solid #e0e0e0}
    .section:last-child{border-bottom:none}
    .section h2{margin-top:0;font-size:1.5em;color:#333}
    .flex-container{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
    .flex-item{flex:1;min-width:260px}
    select,button,input[type="text"]{padding:10px;font-size:1em;border:1px solid #ccc;border-radius:4px;width:100%;margin-bottom:10px}
    button{background:#007e83;color:#fff;border:none;cursor:pointer}
    button:hover{background:#5fb9bc}
    .attributes-search,.destinations-search{width:100%;margin-bottom:10px}
    .attributes-list,.destinations-list,.certifications-list{max-height:220px;overflow-y:auto;border:1px solid #ccc;border-radius:4px;padding:10px;position:relative}
    .attribute-item,.market-item,.certification-item{display:flex;align-items:center;margin-bottom:6px;position:relative}
    .attribute-item input,.market-item input,.certification-item input{margin-right:10px}
    .compliance-roadmap{margin-top:20px;padding:15px;background:#F5F5F5;border:1px solid #e0e0e0;border-radius:4px}
    .compliance-roadmap h3{margin-top:0;color:#006666}
    .compliance-roadmap ul{list-style:none;padding:0;margin:0 0 18px 0}
    .compliance-roadmap li{padding:5px 0;color:#333}
    .button-group{display:flex;gap:16px;flex-wrap:wrap;align-items:stretch;margin-top:28px}
    .button-group button{flex:1;min-width:220px;border-radius:8px}
    .export-btn{background:#C86DD7}
    .export-btn:hover{background:#B55AC3}
    .export-csv-btn{background:#FF6200}
    .export-csv-btn:hover{background:#E55B00}
    .tooltip{position:relative}
    .tooltip .tooltiptext{visibility:hidden;min-width:220px;max-width:360px;background:#007e83;color:#fff;text-align:left;border-radius:4px;padding:6px 8px;position:fixed;z-index:1000;opacity:0;transition:opacity .2s;font-size:.9em}
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
    .req-star::after{content:" *required"; color:#b00020; font-weight:600; margin-left:4px}
    .hint{color:#666;font-size:0.9em;margin:6px 0 12px}
    .req-badge{color:#b00020;font-weight:600}
    /* Variant UI */
    .variant-panel{display:none;margin-top:12px;padding:12px;border:1px dashed #cfe8e8;border-radius:8px;background:#f8fcfc}
    .variant-details{display:none;gap:20px;flex-wrap:wrap;margin-top:6px}
    .variant-note{font-size:0.9em;color:#444;margin:8px 0 0}
    /* Attribute suggestion highlight */
    .suggested-attr{background:#FFF8E1;border-radius:4px;padding:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Compliance Roadmap</h1></div>

    <!-- Define Product -->
    <div class="section">
      <h2>Define Specification</h2>
      <div class="flex-container">
        <div class="flex-item">
          <label for="product">Products or Systems</label>
          <select id="product">
            <option value="none">Select Product or System</option>
            <option value="machinery">Machinery (EN IEC 60204-1)</option>
            <option value="low-voltage-switchgear">Low-voltage switchgear and controlgear assemblies (EN IEC 61439-1/-2)</option>
            <option value="alarm-systems">Alarm systems for intrusion and hold-up installations (EN 50131-1)</option>
            <option value="lightning-protection">Protection against lightning: Electrical/electronic systems within structures (EN IEC 62305-4)</option>
            <option value="electrical-equipment-measurement">Electrical equipment for measurement, control and laboratory use (EN 61010-1)</option>
            <option value="explosive-atmospheres-installation">Explosive atmospheres – Electrical installation (EN IEC 60079-14)</option>
            <option value="traction-batteries">Traction batteries (EN 62485-3)</option>
            <option value="laser-products">Laser products: equipment (EN 60825-1)</option>
            <option value="luminaires">Luminaires (EN IEC 60598-1)</option>
            <option value="explosive-atmospheres-equipment">Equipment for Explosive atmospheres (EN IEC 60079-0)</option>
            <option value="medical-electrical-equipment">Medical electrical equipment (EN 60601-1)</option>
            <option value="heat-pumps-airconditioners">Electrical heat pumps, air conditioners and dehumidifiers (EN IEC 60335-2-40)</option>
            <option value="stationary-batteries">Stationary batteries (EN IEC 62485-2)</option>
            <option value="power-installations">Power installations exceeding 1 kV AC / 1.5 kV DC (EN IEC 61936-1)</option>
            <option value="audio-video-equipment">Audio/video, information & communication technology equipment (EN IEC 62368-1)</option>
            <option value="photovoltaic-systems">Photovoltaic (PV) grid connected systems (EN 62446-1)</option>
            <option value="low-voltage-cables">Low-voltage energy cables ≤ 450/750 V (EN 50525-1)</option>
            <option value="video-surveillance">Video surveillance systems for use in security applications (EN 62676-4)</option>
            <option value="commercial-refrigerating">Commercial refrigerating appliances and ice-makers (EN IEC 60335-2-89)</option>
            <option value="air-cleaning-appliances">Air-cleaning appliances (EN 60335-2-65)</option>
          </select>
        </div>
      </div>

      <!-- Machinery Variant Panel (only visible when Machinery selected) -->
      <div id="machinery-variant-panel" class="variant-panel">
        <div class="flex-container">
          <div class="flex-item">
            <label for="variant-select">Machinery Variant</label>
            <select id="variant-select">
              <option value="none">Select a Machinery variant</option>
              <!-- options populated from catalog.json -->
            </select>
          </div>
        </div>

        <div id="variant-details-wrapper" class="variant-details">
          <!-- detail selects rendered here from catalog.json based on chosen variant -->
        </div>

        <p class="variant-note">
          Tip: Selecting variant/details may auto-check or suggest attributes below (highlighted). You can still adjust them manually.
        </p>
      </div>
    </div>

    <!-- Attributes -->
    <div class="section">
      <h2>Select Attributes</h2>
      <input type="text" id="attributes-search" class="attributes-search" placeholder="Search attributes...">
      <div class="attributes-list" id="attributes-list">
        <div class="attribute-item" data-products="traction-batteries,stationary-batteries,photovoltaic-systems,medical-electrical-equipment">
          <input type="checkbox" id="contains-battery" value="contains-battery">
          <label for="contains-battery" class="tooltip">Contains Battery (Lithium or Other)
            <span class="tooltiptext">UN 38.3 transport (global); EU Battery Regulation (2023/1542). EN 62133-2 (portable) or EN 62619 (industrial/ESS).</span>
          </label>
        </div>
        <div class="attribute-item" data-products="audio-video-equipment,video-surveillance">
          <input type="checkbox" id="wireless-connectivity" value="wireless-connectivity">
          <label for="wireless-connectivity" class="tooltip">Wireless Connectivity (Wi-Fi/Bluetooth)
            <span class="tooltiptext">EU RED (2014/53/EU)/UK Radio Regs; ETSI EN 300 328 & EN 301 489 series. US: FCC Part 15.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="audio-video-equipment,video-surveillance">
          <input type="checkbox" id="integrated-display" value="integrated-display">
          <label for="integrated-display" class="tooltip">Integrated Display
            <span class="tooltiptext">Energy Labelling framework (2017/1369) + product rules (e.g., (EU) 2019/2013 electronic displays). IEC/EN 62087 methods may apply.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="machinery,low-voltage-switchgear,heat-pumps-airconditioners,commercial-refrigerating,air-cleaning-appliances,medical-electrical-equipment">
          <input type="checkbox" id="external-power-supply" value="external-power-supply">
          <label for="external-power-supply" class="tooltip">External Power Supply
            <span class="tooltiptext">(EU) 2019/1782 Ecodesign for EPS; safety typically under EN 62368-1 or relevant product standard.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="explosive-atmospheres-installation,explosive-atmospheres-equipment,power-installations">
          <input type="checkbox" id="hazardous-environment-design" value="hazardous-environment-design">
          <label for="hazardous-environment-design" class="tooltip">Hazardous Environment Design
            <span class="tooltiptext">ATEX equipment: EU 2014/34/EU (CE). Installations: EN IEC 60079-14 and national codes. UK: UKEX.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="electrical-equipment-measurement,medical-electrical-equipment">
          <input type="checkbox" id="medical-application" value="medical-application">
          <label for="medical-application" class="tooltip">Medical Application
            <span class="tooltiptext">EU MDR replaces LVD; EN 60601-1, EN 60601-1-2, EN 62366, EN ISO 14971. US: FDA 21 CFR.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables,power-installations">
          <input type="checkbox" id="outdoor-use" value="outdoor-use">
          <label for="outdoor-use" class="tooltip">Outdoor Use
            <span class="tooltiptext">Example: EN 50289-4-1 for certain cable families (UV/weathering) – check product family specifics.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables">
          <input type="checkbox" id="fire-resistant" value="fire-resistant">
          <label for="fire-resistant" class="tooltip">Fire-Resistant
            <span class="tooltiptext">EN 60332-1-2 single vertical flame; CPR EN 50575 for reaction-to-fire & DoP.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables">
          <input type="checkbox" id="high-temperature-operation" value="high-temperature-operation">
          <label for="high-temperature-operation" class="tooltip">High-Temperature Operation
            <span class="tooltiptext">Use the matching EN 50525-2-xx part for the cable type.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="power-installations">
          <input type="checkbox" id="substation-application" value="substation-application">
          <label for="substation-application" class="tooltip">Substation Application
            <span class="tooltiptext">Installation/system rules (not CE product). Example: IT CEI 11-27.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="power-installations,photovoltaic-systems">
          <input type="checkbox" id="renewable-energy-integration" value="renewable-energy-integration">
          <label for="renewable-energy-integration" class="tooltip">Renewable Energy Integration
            <span class="tooltiptext">EU example: EN 50549-1 for grid-connected generators. National grid codes (DE VDE-AR-N 4105, IT CEI 0-21).</span>
          </label>
        </div>
        <div class="attribute-item" data-products="power-installations">
          <input type="checkbox" id="overhead-lines" value="overhead-lines">
          <label for="overhead-lines" class="tooltip">Overhead Lines
            <span class="tooltiptext">EN 50341-1 for AC overhead lines >1 kV (installation/system).</span>
          </label>
        </div>
        <div class="attribute-item" data-products="photovoltaic-systems">
          <input type="checkbox" id="off-grid-capability" value="off-grid-capability">
          <label for="off-grid-capability" class="tooltip">Off-Grid Capability
            <span class="tooltiptext">Use EN 62109-1/-2 for PV power converters where applicable.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="photovoltaic-systems">
          <input type="checkbox" id="battery-storage-included" value="battery-storage-included">
          <label for="battery-storage-included" class="tooltip">Battery Storage Included
            <span class="tooltiptext">Industrial/ESS: EN 62619 + EU Battery Regulation; UN 38.3 for transport.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="photovoltaic-systems">
          <input type="checkbox" id="large-scale-installation" value="large-scale-installation">
          <label for="large-scale-installation" class="tooltip">Large-Scale Installation
            <span class="tooltiptext">Example: IT CEI 0-16 (MV grid connection). System rule, not CE product.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="low-voltage-cables,power-installations,photovoltaic-systems,medical-electrical-equipment,audio-video-equipment,video-surveillance,luminaires,heat-pumps-airconditioners,commercial-refrigerating,air-cleaning-appliances,electrical-equipment-measurement,low-voltage-switchgear">
          <input type="checkbox" id="contains-hazardous-chemicals" value="contains-hazardous-chemicals">
          <label for="contains-hazardous-chemicals" class="tooltip">Contains Hazardous Chemicals
            <span class="tooltiptext">EU REACH (EC 1907/2006) & EU RoHS (2011/65/EU) where EEE; WEEE producer duties where applicable.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="audio-video-equipment,video-surveillance,medical-electrical-equipment">
          <input type="checkbox" id="data-processing-capability" value="data-processing-capability">
          <label for="data-processing-capability" class="tooltip">Data Processing Capability
            <span class="tooltiptext">Security by design: IEC 62443 (industrial) / ETSI EN 303 645 (consumer IoT). GDPR for personal data in EU.</span>
          </label>
        </div>
        <div class="attribute-item" data-products="machinery,low-voltage-switchgear,heat-pumps-airconditioners,commercial-refrigerating,air-cleaning-appliances,medical-electrical-equipment,laser-products,luminaires,explosive-atmospheres-equipment">
          <input type="checkbox" id="safety-critical-component" value="safety-critical-component">
          <label for="safety-critical-component" class="tooltip">Safety-Critical Component
            <span class="tooltiptext">Expect tighter safety evidence under the relevant product standard (e.g., EN 60204-1, EN 60598-1, EN 60601-1, etc.).</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Certifications -->
    <div class="section">
      <h2>Certification Bodies/Goals</h2>
      <div class="certifications-list" id="certifications-list">
        <div class="certification-item">
          <input type="checkbox" id="ce-marking" value="ce-marking">
          <label for="ce-marking" class="tooltip">CE Marking (EU)
            <span class="tooltiptext">EU conformity (e.g., LVD/EMC/RED, MDR, ATEX, CPR). Requires EU Declaration of Conformity & technical documentation.</span>
          </label>
        </div>
        <div class="certification-item">
          <input type="checkbox" id="ukca-ce-gb" value="ukca-ce-gb">
          <label for="ukca-ce-gb" class="tooltip">UKCA / CE (Great Britain)
            <span class="tooltiptext">GB recognises CE marking indefinitely for most sectors; UKCA also valid. Medical devices have separate timelines.</span>
          </label>
        </div>
        <div class="certification-item">
          <input type="checkbox" id="ul-listing" value="ul-listing">
          <label for="ul-listing" class="tooltip">NRTL Listing (UL/CSA/ETL)
            <span class="tooltiptext">US: OSHA expects NRTL-listed equipment for workplaces. Listing to applicable UL/ANSI or CSA standards.</span>
          </label>
        </div>
        <div class="certification-item">
          <input type="checkbox" id="fda-approval" value="fda-approval">
          <label for="fda-approval" class="tooltip">FDA (US medical devices)
            <span class="tooltiptext">Device classification & premarket (510(k)/PMA) under 21 CFR; QMS alignment (ISO 13485).</span>
          </label>
        </div>
        <div class="certification-item">
          <input type="checkbox" id="ce-notified-body" value="ce-notified-body">
          <label for="ce-notified-body" class="tooltip">Notified Body / UK Approved Body
            <span class="tooltiptext">Third-party involvement where the conformity route requires it (e.g., MDR, ATEX, certain modules). NB/UKAB ID with marking when applicable.</span>
          </label>
        </div>
      </div>

      <!-- GB marking plan, appears only when UK selected -->
      <div id="gb-marking-plan" style="display:none; margin-top:8px;">
        <label for="gb-plan">GB marking plan</label>
        <select id="gb-plan">
          <option value="ce">CE only (permitted for most sectors)</option>
          <option value="ukca">UKCA only</option>
          <option value="dual">Dual marking (CE + UKCA)</option>
        </select>
      </div>
    </div>

    <!-- Origin -->
    <div class="section">
      <h2>Place of manufacture (origin)</h2>
      <div class="flex-container">
        <div class="flex-item">
          <select id="country-of-origin">
            <option value="none">Select origin country</option>
            <option value="france">France</option>
            <option value="germany">Germany</option>
            <option value="italy">Italy</option>
            <option value="uk">United Kingdom</option>
            <option value="usa">United States</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Destination -->
    <div class="section">
      <h2>Destination market(s)</h2>
      <input type="text" id="destinations-search" class="destinations-search" placeholder="Search destinations...">
      <div class="destinations-list" id="destinations-list">
        <div class="market-item"><input type="checkbox" id="destination-france" value="france"><label for="destination-france">France (EU)</label></div>
        <div class="market-item"><input type="checkbox" id="destination-germany" value="germany"><label for="destination-germany">Germany (EU)</label></div>
        <div class="market-item"><input type="checkbox" id="destination-italy" value="italy"><label for="destination-italy">Italy (EU)</label></div>
        <div class="market-item"><input type="checkbox" id="destination-uk" value="uk"><label for="destination-uk">United Kingdom (UK)</label></div>
        <div class="market-item"><input type="checkbox" id="destination-usa" value="usa"><label for="destination-usa">United States of America (USA)</label></div>
      </div>
    </div>

    <!-- Advanced -->
    <div class="section" id="advanced-section" style="display:none;">
      <h2>Advanced &amp; economic operators</h2>
      <p class="hint">
        Fields below are optional unless your selections make them required.
        Required fields are marked with <span class="req-badge">*required</span>.
      </p>

      <div class="flex-container">
        <div class="flex-item">
          <label for="legal-manufacturer-country">Legal manufacturer country (optional)</label>
          <select id="legal-manufacturer-country">
            <option value="none">Same as place of manufacture</option>
            <option value="france">France</option>
            <option value="germany">Germany</option>
            <option value="italy">Italy</option>
            <option value="uk">United Kingdom</option>
            <option value="usa">United States</option>
          </select>
        </div>
      </div>

      <div id="eu-ops" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px;">EU economic operator locations</h3>
        <div class="flex-container">
          <div class="flex-item">
            <label id="lbl-eu-importer" for="eu-importer-country">EU importer country</label>
            <select id="eu-importer-country">
              <option value="none">Select country</option>
              <option value="france">France</option>
              <option value="germany">Germany</option>
              <option value="italy">Italy</option>
            </select>
          </div>
          <div class="flex-item">
            <label id="lbl-eu-ar" for="eu-ar-country">EU Authorized Representative country (if applicable)</label>
            <select id="eu-ar-country">
              <option value="none">Not applicable / not yet decided</option>
              <option value="france">France</option>
              <option value="germany">Germany</option>
              <option value="italy">Italy</option>
            </select>
          </div>
        </div>
      </div>

      <div id="uk-ops" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px;">UK economic operator locations</h3>
        <div class="flex-container">
          <div class="flex-item">
            <label id="lbl-uk-importer" for="uk-importer-country">UK importer country</label>
            <select id="uk-importer-country">
              <option value="none">Select country</option>
              <option value="uk">United Kingdom</option>
            </select>
          </div>
          <div class="flex-item">
            <label id="lbl-ukrp" for="ukrp-country">UK Responsible Person (UKRP) country (if applicable)</label>
            <select id="ukrp-country">
              <option value="none">Not applicable / not yet decided</option>
              <option value="uk">United Kingdom</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="section">
      <button id="btn-generate">Generate Compliance Roadmap</button>
    </div>

    <!-- Output -->
    <div class="section" id="roadmap-section" style="display:none;">
      <h2>Compliance Roadmap</h2>
      <div class="compliance-roadmap" id="roadmap-content">
        <h3>Applicable Standards and Requirements</h3>
        <ul id="roadmap-list"></ul>
        <div class="button-group">
          <button class="export-btn" id="btn-export-citation">Create My Review</button>
          <button class="export-csv-btn" id="btn-export-csv">Export My Requirements</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Globals & Catalog ===== */
let CATALOG = null;

async function loadCatalog(){
  try{
    const res = await fetch('catalog.json', {cache:'no-store'});
    if (!res.ok) throw new Error('catalog.json not found');
    CATALOG = await res.json();
    // populate machinery variants
    populateVariantFromCatalog('machinery');
  }catch(e){
    console.warn('Catalog load failed:', e.message);
  }
}

/* ===== UI helpers ===== */
const EU_SET = new Set(['italy','germany','france']);
const MARKET_GROUP = { germany:'eu', france:'eu', italy:'eu', uk:'uk', usa:'us' };

function filterAttributes() {
  const q = document.getElementById('attributes-search').value.toLowerCase();
  document.querySelectorAll('.attribute-item').forEach(item => {
    const label = item.querySelector('label').textContent.toLowerCase();
    item.style.display = label.includes(q) ? 'flex' : 'none';
  });
}
function filterDestinations() {
  const q = document.getElementById('destinations-search').value.toLowerCase();
  document.querySelectorAll('.market-item').forEach(item => {
    const label = item.querySelector('label').textContent.toLowerCase();
    item.style.display = label.includes(q) ? 'flex' : 'none';
  });
}
function anyEUSelected(){ return getSelectedDestinations().some(x => EU_SET.has(x)); }
function anyUKSelected(){ return getSelectedDestinations().includes('uk'); }
function toggleAdvancedSection(){
  const adv = document.getElementById('advanced-section');
  const euOps = document.getElementById('eu-ops');
  const ukOps = document.getElementById('uk-ops');
  const gbPlan = document.getElementById('gb-marking-plan');
  const show = anyEUSelected() || anyUKSelected();
  adv.style.display = show ? 'block' : 'none';
  euOps.style.display = anyEUSelected() ? 'block' : 'none';
  ukOps.style.display = anyUKSelected() ? 'block' : 'none';
  gbPlan.style.display = anyUKSelected() ? 'block' : 'none';
  markRequiredFields();
}
document.addEventListener('change', (e)=>{
  if (e.target.closest('.market-item')) toggleAdvancedSection();
});
function positionTooltip(element){
  const tip = element.querySelector('.tooltiptext'); if(!tip) return;
  const rect = element.getBoundingClientRect();
  tip.style.left = (rect.left + rect.width/2)+'px';
  tip.style.top  = (rect.top - tip.offsetHeight - 10)+'px';
}
document.addEventListener('mouseover', (e)=>{
  const t = e.target.closest('.tooltip');
  if (t) positionTooltip(t);
});

function updateAttributes(){
  const product = document.getElementById('product').value;
  document.querySelectorAll('.attribute-item').forEach(item => {
    const applicable = item.getAttribute('data-products').split(',');
    const cb = item.querySelector('input[type="checkbox"]');
    if (product === 'none' || applicable.includes(product)) {
      item.style.display = 'flex'; cb.disabled = false;
    } else {
      item.style.display = 'none'; cb.checked = false; cb.disabled = true;
    }
  });
  document.getElementById('attributes-search').value = '';
}

/* ===== Get selections ===== */
function getSelectedAttributes(){
  return Array.from(document.querySelectorAll('.attribute-item input[type="checkbox"]:checked')).map(el => el.value);
}
function getSelectedCertifications(){
  return Array.from(document.querySelectorAll('.certification-item input[type="checkbox"]:checked')).map(el => el.value);
}
function getSelectedDestinations(){
  return Array.from(document.querySelectorAll('.market-item input[type="checkbox"]:checked')).map(el => el.value);
}

/* ===== Dest-aware display filter ===== */
function showRequirement(req, destinations){
  if (!req.specificMarkets || req.specificMarkets.length === 0) return true;
  const EU = new Set(['germany','france','italy']);
  return req.specificMarkets.some(m => {
    if (m === 'eu') return destinations.some(d => EU.has(d));
    return destinations.includes(m);
  });
}

/* ===== Required state for operators ===== */
function computeOperatorRequirements() {
  const destinations = getSelectedDestinations();
  const legalManu = (document.getElementById('legal-manufacturer-country')?.value || 'none');
  const origin = document.getElementById('country-of-origin').value;
  const manufacturerCountry = (legalManu !== 'none') ? legalManu : origin;
  const goingEU = destinations.some(d => ['italy','germany','france'].includes(d));
  const goingUK = destinations.includes('uk');
  const isMedical = (document.getElementById('product').value === 'medical-electrical-equipment')
                    || getSelectedAttributes().includes('medical-application');
  return {
    needsEUImporter: goingEU && !['italy','germany','france'].includes(manufacturerCountry),
    needsEUAR:       goingEU && isMedical && !['italy','germany','france'].includes(manufacturerCountry),
    needsGBImporter: goingUK && manufacturerCountry !== 'uk',
    needsUKRP:       goingUK && isMedical && manufacturerCountry !== 'uk'
  };
}
function labelReq(selectId, isReq){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const lbl = sel.closest('.flex-item')?.querySelector('label');
  if (!lbl) return;
  lbl.classList.toggle('req-star', isReq);
}
function markRequiredFields() {
  const r = computeOperatorRequirements();
  // EU
  labelReq('eu-importer-country', r.needsEUImporter);
  labelReq('eu-ar-country', r.needsEUAR);
  document.getElementById('eu-importer-country')?.toggleAttribute('aria-required', r.needsEUImporter);
  document.getElementById('eu-ar-country')?.toggleAttribute('aria-required', r.needsEUAR);
  // UK
  labelReq('uk-importer-country', r.needsGBImporter);
  labelReq('ukrp-country', r.needsUKRP);
  document.getElementById('uk-importer-country')?.toggleAttribute('aria-required', r.needsGBImporter);
  document.getElementById('ukrp-country')?.toggleAttribute('aria-required', r.needsUKRP);
}
function requireWhenNeeded() {
  const r = computeOperatorRequirements();
  if (r.needsEUImporter && document.getElementById('eu-importer-country').value === 'none') {
    alert('Please select an EU importer country.'); return false;
  }
  if (r.needsEUAR && document.getElementById('eu-ar-country').value === 'none') {
    alert('Please select an EU Authorized Representative country.'); return false;
  }
  if (r.needsGBImporter && document.getElementById('uk-importer-country').value === 'none') {
    alert('Please select the GB importer country.'); return false;
  }
  if (r.needsUKRP && document.getElementById('ukrp-country').value === 'none') {
    alert('Please select the UK Responsible Person country.'); return false;
  }
  return true;
}
document.getElementById('country-of-origin').addEventListener('change', markRequiredFields);
document.getElementById('legal-manufacturer-country').addEventListener('change', markRequiredFields);

/* ===== Market frameworks ===== */
const ukMarkingPolicy = {
  general: { ceRecognition: 'indefinite' },
  medical: { ceRecognitionUntilMost: '2028-06-30', ceRecognitionUntilSome: '2030-06-30' }
};

function baseFrameworks(product, attrs, destinations){
  const needWireless = attrs.includes('wireless-connectivity');
  const results = [];
  const add = (text, mkts=[]) => results.push({ text, specificMarkets: mkts });

  // EU block
  if (destinations.some(d => MARKET_GROUP[d] === 'eu')) {
    const EU = ['eu'];

    const addLVD_EMC = () => {
      add('EU LVD (2014/35/EU): electrical safety (CE, EU DoC, technical file).', EU);
      add('EU EMC (2014/30/EU): electromagnetic compatibility (CE).', EU);
    };

    switch (product) {
      case 'machinery':
        add('EU Machinery Directive 2006/42/EC / transition to Machinery Regulation (EU) 2023/1230: CE; NB involvement per category.', EU);
        add('EU EMC (2014/30/EU): applies to machinery with electrical equipment.', EU);
        add('Note: LVD does not apply to equipment within the scope of the Machinery regime.', EU);
        add('Apply EN ISO 12100 risk assessment and EN 60204-1 for electrical equipment of machinery.', EU);
        break;
      case 'low-voltage-switchgear':
      case 'electrical-equipment-measurement':
      case 'heat-pumps-airconditioners':
      case 'commercial-refrigerating':
      case 'air-cleaning-appliances':
      case 'luminaires':
        addLVD_EMC();
        break;
      case 'audio-video-equipment':
      case 'video-surveillance':
        addLVD_EMC();
        if (needWireless) add('EU RED (2014/53/EU): radio spectrum + safety + EMC under RED (CE).', EU);
        break;
      case 'explosive-atmospheres-equipment':
        add('EU ATEX Product Directive (2014/34/EU): CE; NB involvement by category/zone.', EU);
        break;
      case 'medical-electrical-equipment':
        add('EU MDR (2017/745): CE; EN 60601-1 safety; EN 60601-1-2 EMC; EN 62366 usability; EN ISO 14971 risk. NB involvement per class. LVD is not applied.', EU);
        break;
      case 'low-voltage-cables':
        add('EU CPR (305/2011) for reaction-to-fire (EN 50575): CE with Declaration of Performance (DoP).', EU);
        break;
      case 'photovoltaic-systems':
      case 'power-installations':
        add('EU: installation/system standards apply; CE marking is for constituent equipment (e.g., inverters under LVD/EMC).', EU);
        break;
      default:
        if (!['traction-batteries','stationary-batteries','laser-products','alarm-systems','lightning-protection','explosive-atmospheres-installation'].includes(product)) {
          addLVD_EMC();
        }
    }

    // Cross-cutting EU
    if (['audio-video-equipment','video-surveillance','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','electrical-equipment-measurement','low-voltage-switchgear'].includes(product)) {
      add('EU RoHS (2011/65/EU) where in EEE scope.', EU);
      add('EU WEEE (2012/19/EU) producer obligations where in scope.', EU);
    }
    if (attrs.includes('contains-battery') || product==='stationary-batteries' || product==='traction-batteries' || attrs.includes('battery-storage-included')) {
      add('EU Battery Regulation (2023/1542): EPR, sustainability, information & safety requirements.', EU);
      add('UN 38.3 transport tests for lithium cells/batteries (global).', []);
    }
    if (needWireless) add('ETSI EN 300 328 / EN 301 489 series as applicable for RED testing.', EU);
  }

  // UK block
  if (destinations.includes('uk')) {
    add('GB Electrical Equipment (Safety) Regulations 2016 (UK LVD analogue).', ['uk']);
    add('GB EMC Regulations 2016.', ['uk']);
    if (needWireless) add('GB Radio Equipment Regulations 2017.', ['uk']);
    if (product === 'explosive-atmospheres-equipment') add('UKEX: Equipment for Use in Potentially Explosive Atmospheres Regulations 2016.', ['uk']);
    if (product === 'medical-electrical-equipment') add('UK Medical Devices Regulations 2002 (as amended).', ['uk']);
    if (['audio-video-equipment','video-surveillance','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','electrical-equipment-measurement','low-voltage-switchgear'].includes(product)) {
      add('GB RoHS analogue; GB WEEE producer obligations (scope-dependent).', ['uk']);
    }
    add(`GB: CE marking recognised ${ukMarkingPolicy.general.ceRecognition} for most sectors; UKCA also valid. Choose CE, UKCA or dual strategy.`, ['uk']);
    if (product === 'medical-electrical-equipment') {
      add(`GB medical devices: CE acceptance timelines vary (e.g., to ${ukMarkingPolicy.medical.ceRecognitionUntilMost} / ${ukMarkingPolicy.medical.ceRecognitionUntilSome} by class). Plan UKRP and importer accordingly.`, ['uk']);
    }
  }

  // US block
  if (destinations.includes('usa')) {
    if (needWireless) add('FCC 47 CFR Part 15 (intentional radiators): certification/SDoC as applicable.', ['usa']);
    else add('FCC 47 CFR Part 15B (unintentional radiators): SDoC for digital devices where applicable.', ['usa']);
    if (['machinery','low-voltage-switchgear','electrical-equipment-measurement','luminaires','heat-pumps-airconditioners','commercial-refrigerating','air-cleaning-appliances','audio-video-equipment','video-surveillance'].includes(product)) {
      add('OSHA: NRTL listing typically expected for workplace installation (UL/CSA/ETL to relevant standards).', ['usa']);
    }
    if (product === 'medical-electrical-equipment') {
      add('FDA 21 CFR: device classification and premarket submission (510(k)/PMA); QMS (ISO 13485 alignment).', ['usa']);
    }
    if (attrs.includes('contains-battery') || product==='stationary-batteries' || product==='traction-batteries' || attrs.includes('battery-storage-included')) {
      add('US: UN 38.3 + 49 CFR hazmat shipping requirements for lithium batteries.', ['usa']);
    }
  }

  return results;
}

/* ===== Variant injection to requirements ===== */
function getSelectedVariantId(){
  const sel = document.getElementById('variant-select');
  return sel ? sel.value : 'none';
}
function getSelectedVariantDetailMap(){
  const map = {};
  const wrap = document.getElementById('variant-details-wrapper');
  if (!wrap) return map;
  wrap.querySelectorAll('select').forEach(sel=>{
    const key = sel.getAttribute('data-detail-id');
    if (!key) return;
    if (sel.multiple) {
      map[key] = Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v && v!=='none');
    } else {
      map[key] = sel.value && sel.value!=='none' ? [sel.value] : [];
    }
  });
  return map;
}
function pushVariantNotes(requirements, product, destinations){
  if (product !== 'machinery' || !CATALOG) return;
  const variantId = getSelectedVariantId();
  if (!variantId || variantId === 'none') return;
  const v = CATALOG?.products?.machinery?.variants?.find(x=>x.id===variantId);
  if (!v) return;

  const add = (text, mkts=[]) => requirements.push({ text, specificMarkets: mkts });

  // Base variant notes by market
  if (destinations.some(d=>MARKET_GROUP[d]==='eu')) (v.eu||[]).forEach(line=>add(line, ['eu']));
  if (destinations.includes('uk')) (v.uk||[]).forEach(line=>add(line, ['uk']));
  if (destinations.includes('usa')) (v.us||[]).forEach(line=>add(line, ['usa']));

  // Details "adds"
  const detailMap = getSelectedVariantDetailMap();
  (v.details||[]).forEach(d=>{
    (detailMap[d.id]||[]).forEach(optId=>{
      const opt = (d.options||[]).find(o=>o.id===optId);
      if (!opt) return;
      if (destinations.some(m=>MARKET_GROUP[m]==='eu')) (opt.adds?.eu||[]).forEach(line=>add(line,['eu']));
      if (destinations.includes('uk')) (opt.adds?.uk||[]).forEach(line=>add(line,['uk']));
      if (destinations.includes('usa')) (opt.adds?.us||[]).forEach(line=>add(line,['usa']));
    });
  });

  // Cross-cuts
  (CATALOG?.products?.machinery?.crossCuts||[]).forEach(line=>add(line, ['eu']));
}

/* ===== Variant-driven attribute hints ===== */
function clearAttrSuggestions(){
  document.querySelectorAll('.attribute-item').forEach(d => d.classList.remove('suggested-attr'));
}
function applyVariantAttributeHints(){
  clearAttrSuggestions();

  const product = document.getElementById('product').value;
  if (product !== 'machinery' || !CATALOG) return;

  const variantId = getSelectedVariantId();
  const variant = CATALOG?.products?.machinery?.variants?.find(v => v.id === variantId);
  if (!variant) return;

  const toCheck = new Set(variant.attributes?.check || []);
  const toSuggest = new Set(variant.attributes?.suggest || []);

  const detailMap = getSelectedVariantDetailMap();
  (variant.details || []).forEach(d => {
    (detailMap[d.id] || []).forEach(optId => {
      const opt = (d.options || []).find(o => o.id === optId);
      if (!opt) return;
      (opt.attributes?.check || []).forEach(a => toCheck.add(a));
      (opt.attributes?.suggest || []).forEach(a => toSuggest.add(a));
    });
  });

  // Auto-tick
  toCheck.forEach(id => {
    const el = document.getElementById(id);
    if (el && el.type === 'checkbox' && !el.disabled) el.checked = true;
  });

  // Visual suggestions
  toSuggest.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const box = el.closest('.attribute-item');
    if (box) box.classList.add('suggested-attr');
  });
}

/* ===== Populate Machinery variant UI from catalog ===== */
function populateVariantFromCatalog(product){
  const panel = document.getElementById('machinery-variant-panel');
  const select = document.getElementById('variant-select');
  const detailsWrap = document.getElementById('variant-details-wrapper');

  if (product === 'machinery') {
    panel.style.display = 'block';
    // Fill variants
    if (CATALOG?.products?.machinery?.variants) {
      // preserve first "none"
      select.innerHTML = '<option value="none">Select a Machinery variant</option>' +
        CATALOG.products.machinery.variants.map(v=>`<option value="${v.id}">${v.label}</option>`).join('');
    } else {
      select.innerHTML = '<option value="none">Select a Machinery variant</option>';
    }

    // clear details
    detailsWrap.innerHTML = '';
    detailsWrap.style.display = 'none';

    // attach on change
    select.onchange = populateVariantDetails;
  } else {
    panel.style.display = 'none';
  }
}
function populateVariantDetails(){
  const select = document.getElementById('variant-select');
  const variantId = select.value;
  const detailsWrap = document.getElementById('variant-details-wrapper');
  detailsWrap.innerHTML = '';
  detailsWrap.style.display = 'none';
  if (!CATALOG || !CATALOG.products?.machinery) return;

  const variant = CATALOG.products.machinery.variants.find(v=>v.id===variantId);
  if (!variant || !variant.details || !variant.details.length) {
    applyVariantAttributeHints();
    return;
  }

  variant.details.forEach(d=>{
    const cap = document.createElement('div');
    cap.className = 'flex-item';
    const label = document.createElement('label');
    label.textContent = d.label;
    const sel = document.createElement('select');
    sel.setAttribute('data-detail-id', d.id);
    if (d.type === 'multi') sel.multiple = true;

    if (!sel.multiple) sel.innerHTML = '<option value="none">Select</option>';
    (d.options||[]).forEach(o=>{
      const opt = document.createElement('option');
      opt.value = o.id; opt.textContent = o.label;
      sel.appendChild(opt);
    });

    cap.appendChild(label); cap.appendChild(sel);
    detailsWrap.appendChild(cap);

    sel.addEventListener('change', applyVariantAttributeHints);
  });

  detailsWrap.style.display = 'flex';
  applyVariantAttributeHints();
}

/* ===== Certification-specific requirements ===== */
function certificationRequirements(certifications, product, attrs, destinations){
  const results = [];
  const add = (text, mkts=[]) => results.push({ text, specificMarkets: mkts });

  if (certifications.includes('ce-marking') && destinations.some(d => MARKET_GROUP[d]==='eu')) {
    add('EU: Prepare EU Declaration of Conformity referencing applicable directives/regulations and harmonised standards.', ['eu']);
    add('EU: Compile technical documentation (risk assessment, test reports, drawings, instructions, labeling, conformity assessment route).', ['eu']);
    if (product === 'explosive-atmospheres-equipment' || product === 'medical-electrical-equipment') {
      add('EU: Notified Body involvement likely (depending on ATEX category / MDR class).', ['eu']);
    }
  }

  if (certifications.includes('ukca-ce-gb') && destinations.includes('uk')) {
    add('GB: Implement chosen marking plan (CE only / UKCA only / dual). Keep UK Declaration of Conformity and technical documentation.', ['uk']);
    const gbPlan = document.getElementById('gb-plan')?.value || 'ce';
    add(`GB plan selected: ${gbPlan.toUpperCase()}.`, ['uk']);
  }

  if (certifications.includes('ul-listing') && destinations.includes('usa')) {
    add('US: Obtain NRTL listing (UL/CSA/ETL) to the applicable UL/ANSI or CSA standard for workplace acceptance.', ['usa']);
  }

  if (certifications.includes('fda-approval') && destinations.includes('usa') &&
     (product === 'medical-electrical-equipment' || attrs.includes('medical-application'))) {
    add('US: Determine device class and premarket pathway (510(k)/PMA); align QMS to 21 CFR / ISO 13485.', ['usa']);
  }

  if (certifications.includes('ce-notified-body')) {
    const mkts = [];
    if (destinations.some(d => MARKET_GROUP[d]==='eu')) mkts.push('eu');
    if (destinations.includes('uk')) mkts.push('uk');
    if (mkts.length) add('Third-party assessment: engage Notified Body / UK Approved Body where the conformity route requires it (e.g., MDR, ATEX, certain modules).', mkts);
  }

  return results;
}

/* ===== Economic operator duties ===== */
function econOperatorDuties(origin, destinations, product, attrs){
  const results = [];
  const add = (text, mkts=[]) => results.push({ text, specificMarkets: mkts });

  const legalManu = (document.getElementById('legal-manufacturer-country')?.value || 'none');
  const manufacturerCountry = (legalManu !== 'none') ? legalManu : origin;

  const goingEU = destinations.some(d => EU_SET.has(d));
  const goingUK = destinations.includes('uk');
  const goingUS = destinations.includes('usa');

  if (goingEU && !EU_SET.has(manufacturerCountry)) {
    add(`EU importer required: name & EU address on product/packaging; ensure CE compliance; hold EU DoC & technical file. ${renderChoice('eu-importer-country','Planned importer')}`, ['eu']);
    const isMedical = (product === 'medical-electrical-equipment') || attrs.includes('medical-application');
    if (isMedical) add(`EU Authorized Representative required for MDR medical devices. ${renderChoice('eu-ar-country','Planned AR')}`, ['eu']);
  }
  if (goingUK && manufacturerCountry !== 'uk') {
    add(`GB importer required: name & GB address; keep UK DoC available; apply chosen GB marking plan. ${renderChoice('uk-importer-country','Planned importer')}`, ['uk']);
    const isMedical = (product === 'medical-electrical-equipment') || attrs.includes('medical-application');
    if (isMedical) add(`UK Responsible Person (UKRP) required for medical devices. ${renderChoice('ukrp-country','Planned UKRP')}`, ['uk']);
  }
  if (goingUS) {
    add('US: coordinate Importer of Record (customs) and ensure FCC/NRTL obligations are met prior to import.', ['usa']);
  }
  return results;
}
function renderChoice(selectId, label){
  const el = document.getElementById(selectId);
  if (!el) return '';
  const v = el.value;
  if (!v || v==='none') return '';
  return `${label}: ${v.toUpperCase()}.`;
}

/* ===== Generate Roadmap ===== */
function generateRoadmap(){
  const productSel = document.getElementById('product');
  const countryOfOrigin = document.getElementById('country-of-origin');
  const roadmapList = document.getElementById('roadmap-list');
  const product = productSel.value;

  const destinations = getSelectedDestinations();
  const attributes = getSelectedAttributes();
  const certifications = getSelectedCertifications();

  if (product === 'none') return alert('Please select a product or system.');
  if (countryOfOrigin.value === 'none') return alert('Please select the place of manufacture (origin).');
  if (destinations.length === 0) return alert('Please select at least one destination market.');
  if (!requireWhenNeeded()) return;

  let requirements = [];

  // Base EN echo
  requirements.push({
    text: `${productSel.options[productSel.selectedIndex].text} – base EN reference captured from the selector.`,
    specificMarkets: []
  });

  // Variant notes (Machinery)
  pushVariantNotes(requirements, product, destinations);

  // Base frameworks
  requirements = requirements.concat(baseFrameworks(product, attributes, destinations));

  // Italy installation/system notes (only for installation/system categories)
  const IT_INSTALL_ONLY = ['power-installations','lightning-protection','photovoltaic-systems'];
  if (destinations.includes('italy') && IT_INSTALL_ONLY.includes(product)) {
    requirements.push({
      text: 'Italy (installation): D.M. 37/2008 + CEI installation codes (e.g., CEI 64-8; CEI 0-21/0-16 for grid connection).',
      specificMarkets: ['italy']
    });
  }

  // Economic operator duties
  requirements = requirements.concat(econOperatorDuties(countryOfOrigin.value, destinations, product, attributes));

  // Certifications
  requirements = requirements.concat(certificationRequirements(certifications, product, attributes, destinations));

  // Render (destination-aware)
  roadmapList.innerHTML = '';
  const filtered = [];
  requirements.forEach(req => {
    if (!showRequirement(req, destinations)) return;
    filtered.push(req);
    const li = document.createElement('li');
    li.textContent = req.text;
    roadmapList.appendChild(li);
  });

  // Stash details
  window.currentRoadmapDetails = {
    product: productSel.options[productSel.selectedIndex].text,
    attributes: attributes,
    certifications: certifications,
    countryOfOrigin: countryOfOrigin.options[countryOfOrigin.selectedIndex].text,
    destinations: destinations,
    requirementsAll: requirements,
    requirementsShown: filtered,
    variant: (product==='machinery') ? getSelectedVariantId() : null,
    variantDetails: (product==='machinery') ? getSelectedVariantDetailMap() : null
  };

  document.getElementById('roadmap-section').style.display = 'block';
}

/* ===== Exports ===== */
function exportToCitation(){
  alert('Exporting to ACS: a Base record plus Detailed requirements with tasks/evidence scaffolding will be created from the roadmap.');
}
function exportToCSV(){
  const d = window.currentRoadmapDetails;
  if (!d) return alert('No requirements to export. Please generate the roadmap first.');

  let csv = '';
  const labels = { 'usa':'United States', 'germany':'Germany', 'france':'France', 'uk':'United Kingdom', 'italy':'Italy' };

  csv += 'Product,"' + d.product.replace(/"/g,'""') + '"\n';
  if (d.variant) csv += 'Variant,"' + d.variant.replace(/"/g,'""') + '"\n';
  if (d.variantDetails){
    const flat = Object.entries(d.variantDetails).map(([k,v])=>`${k}: ${v.join('|')}`).join('; ');
    csv += 'Variant Details,"' + flat.replace(/"/g,'""') + '"\n';
  }
  csv += 'Attributes,"' + (d.attributes.map(a=>a).join(', ') || 'None').replace(/"/g,'""') + '"\n';
  csv += 'Certifications,"' + (d.certifications.map(c=>c).join(', ') || 'None').replace(/"/g,'""') + '"\n';
  csv += 'Origin,"' + d.countryOfOrigin.replace(/"/g,'""') + '"\n';
  csv += 'Destinations,"' + d.destinations.map(x => labels[x]||x).join('; ').replace(/"/g,'""') + '"\n\n';

  csv += 'Requirement,Specific Markets\n';
  (d.requirementsShown || []).forEach(req => {
    const mkts = (req.specificMarkets && req.specificMarkets.length) ? req.specificMarkets.join('; ') : 'All Markets';
    csv += `"${req.text.replace(/"/g,'""')}","${mkts.replace(/"/g,'""')}"\n`;
  });

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url; link.download = 'compliance_requirements.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* ===== Wire up & init ===== */
document.getElementById('product').addEventListener('change', e=>{
  updateAttributes();
  // show/hide machinery variant panel
  populateVariantFromCatalog(e.target.value);
  if (e.target.value !== 'machinery') clearAttrSuggestions();
});
document.getElementById('attributes-search').addEventListener('keyup', filterAttributes);
document.getElementById('destinations-search').addEventListener('keyup', filterDestinations);
document.getElementById('btn-generate').addEventListener('click', generateRoadmap);
document.getElementById('btn-export-citation').addEventListener('click', exportToCitation);
document.getElementById('btn-export-csv').addEventListener('click', exportToCSV);

// Initial paint
updateAttributes();
toggleAdvancedSection();
loadCatalog();
</script>
</body>
</html>
